---
title: "HarpethTMDL"
author: "RJ"
date: "`r Sys.Date()`"
output: html_document
always_allow_html: true
---

```{r, Intro, eval=TRUE}

WASP.version<-8



```

# Introduction

**Harpeth TMDL** --  Water Quality Analysis Simulation Program (WASP version `r WASP.version`)

Exploration of water quality data using the calibrated WASP models provided to TDEC and others by the EPA Region 4


```{r, Setup, warning=FALSE, include=FALSE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE}
#Load in required packages

library(yaml)
library(tidyverse)
library(osmdata) 
library(ggmap)
library(dataRetrieval)
library(XML)
library(DT)
library(dbplyr)
library(widgetframe)
library(rgdal)
library(leaflet)
library(plotly)
library(formattable)
library(htmltools)
library(leaflet)
library(sf)
library(kableExtra)
library(knitr)
library(wql)
library(readxl)
library(fasstr)
library(readr)
library(ggplot2)
library(gridExtra)
library(grid)
library(lattice)
library(reshape)
library(reshape2)
library(forecast)
library(dygraphs)
library(xts)          # To make the convertion data-frame / xts format
library(lubridate)
library(zoo)

time = lubridate::with_tz(Sys.time(), "CST6CDT")

```


This file was last updated on `r time`


```{r, Import Data, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}

#Import Data


Grab <- read_excel("GrabSamples.xlsx", 
    col_types = c("skip", "text", "text", 
        "skip", "skip", "date", "text", "numeric", 
        "text"))

head(Grab,15)

BaseModel <- read_delim("Epa_Base_Model_2011_To_2020.txt", 
     delim = "\t", escape_double = FALSE, 
     col_types = cols(`Date-Time` = col_datetime(format = "%m/%d/%Y %H:%M"), 
         CBOD = col_number(), DO = col_number(), 
         FLOW_CMS = col_number(), NH3_N = col_number(), 
         NO3O2 = col_number(), PHYTO = col_number(), 
         SOD_T = col_number(), `SOLID-WS` = col_number(), 
         TN = col_number(), TP = col_number(), 
         WTEMP = col_number()), trim_ws = TRUE)

head(BaseModel,15)



Cont <- read_csv("Cont.csv", col_types = cols(...1 = col_skip(), 
    Date_Time = col_datetime(format = "%Y-%m-%d %H:%M:%S"), 
    Result = col_number()))

head(Cont,15)



Natural <- read_delim("NATURAL_MODEL_2011_To_2020.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(`Date-Time` = col_datetime(format = "%m/%d/%Y %H:%M"), 
        CBOD90 = col_number(), DIP = col_number(), 
        DO = col_number(), DON = col_number(), 
        DOP = col_number(), FLOW_CMS = col_number(), 
        NH3_N = col_number(), NO3O2 = col_number(), 
        PHYTO = col_number(), PON = col_number(), 
        SOD_T = col_number(), TKN = col_number(), 
        TN = col_number(), TP = col_number(), 
        WTEMP = col_number()), trim_ws = TRUE)

head(Natural,15)


Base_PS <- read_delim("Harpeth_Epa_Base_Model_2_25_X_Ps.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(`Date-Time` = col_datetime(format = "%m/%d/%Y %H:%M"), 
        Station_ID = col_character(), CBOD = col_number(), 
        DIP = col_number(), DO = col_number(), 
        DON = col_number(), DOP = col_number(), 
        FLOW_CMS = col_number(), NH3_N = col_number(), 
        NO3O2 = col_number(), PHYTO = col_number(), 
        PON = col_number(), SOD_T = col_number(), 
        TN = col_number(), TP = col_number(), 
        WTEMP = col_number()), trim_ws = TRUE)
head(Base_PS)


unique(Grab[c(4,6)])


library(readr)
Base_NoFrank <- read_delim("Base_Epa_Model_No_Franklin_Stp_Discharge.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(`Date-Time` = col_datetime(format = "%m/%d/%Y %H:%M"), 
        CBOD = col_number(), DIP = col_number(), 
        DO = col_number(), DON = col_number(), 
        DOP = col_number(), FLOW_CMS = col_number(), 
        NH3_N = col_number(), NO3O2_N = col_number(), 
        PHYTO = col_number(), PON = col_number(), 
        SOD_T = col_number(), TN = col_number(), 
        TP = col_number(), WTEMP = col_number()), 
    trim_ws = TRUE)
head(Base_NoFrank)



library(readr)
NPDES <- read_delim("Point_Source_Wastestream_Dataset.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(`Date-Time` = col_datetime(format = "%m/%d/%Y %H:%M"), 
        CBOD = col_number(), DO = col_number(), 
        FLOW = col_number(), NH3 = col_number(), 
        NOX = col_number(), `NP RATIO` = col_number(), 
        ORGN = col_number(), ORGP = col_number(), 
        PO4 = col_number(), TKN = col_number(), 
        TN = col_number(), TP = col_number(), 
        TSS = col_number(), WTEMP = col_number()), 
    trim_ws = TRUE)






```


`Grab` data table contains grab sample results collected from `r length(unique(Grab$Station_ID))` locations throughout the Harpeth River watershed



```{r, Format, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}

#Subset Data into Logical WASP Segments
# HARPETH_1 = Mouth of the Harpeth
# JONES_167 = Jones Creek
# HARPETH_2 = Main Stem w/o Jones Creek
# TURNBULL_143 = Turnbull Creek
# S_HARPETH_124 = South Harpeth
# HARPETH_34 = West Harpeth
# HARPETH_62 = Upstream of Franklin STP
# LSPC188PERO = Downstream of Franklin STP
# LSPC183PERO = Headwaters
# LSPC192PERO = Hwy100
# LSPC197PERO = 70s Bridge

sites=c("HARPETH_1","JONES_167","HARPETH_2", "TURNBULL_143", "S_HARPETH_124", "HARPETH_34", "LSPC188PERO", "HARPETH_62", "LSPC183PERO","LSPC192PERO", "LSPC197PERO")

colnames(BaseModel)[1] <- "Date"

BaseModel$TPLoad<-BaseModel$TP*0.00220462*BaseModel$FLOW_CMS*86400

BaseModel$TPLoad.csum <- ave(BaseModel$TPLoad, BaseModel$Station_ID, FUN=cumsum)

BaseModel$NP<-BaseModel$TN/BaseModel$TP

BaseModel1<-BaseModel

BaseModel<-BaseModel[BaseModel$Station_ID==sites,]

colnames(Grab)[3] <- "Date"

colnames(Cont)[2] <- "Date"

colnames(Natural)[1] <- "Date"

colnames(Base_PS)[1] <- "Date"

colnames(NPDES)[1] <- "Date"

Natural$NP<-Natural$TN/Natural$TP

Natural$TPLoad<-Natural$TP*0.00220462*Natural$FLOW_CMS*86400

Natural$TPLoad.csum <- ave(Natural$TPLoad, Natural$Station_ID, FUN=cumsum)

Natural1<-Natural

Natural<-Natural[Natural$Station_ID==sites,]



Base_PS<-Base_PS[Base_PS$Station_ID==sites,]

Base_PS$TPLoad<-Base_PS$TP*0.00220462*Base_PS$FLOW_CMS*86400

Base_PS1<-Base_PS

colnames(Base_NoFrank)[1] <- "Date"

Base_NoFrank$TPLoad<-Base_NoFrank$TP*0.00220462*Base_NoFrank$FLOW_CMS*86400

Base_NoFrank$TPLoad.csum <- ave(Base_NoFrank$TPLoad, Base_NoFrank$Station_ID, FUN=cumsum)

Base_NoFrank$NP<-Base_NoFrank$TN/Base_NoFrank$TP

Base_NoFrank1<-Base_NoFrank

Base_NoFrank<-Base_NoFrank[Base_NoFrank$Station_ID==sites,]


NPDES$TPLoad<-NPDES$TP*0.00220462*NPDES$FLOW*86400

NPDES$TPLoad.csum <- ave(NPDES$TPLoad, NPDES$Station_ID, FUN=cumsum)

NPDES$NP<-NPDES$TN/NPDES$TP

NPDES1<-NPDES




#####################################################################################################

molten.data <- melt(Grab, id = c("Date","Station_ID","Pcode","Units","DataSource"))

Grab.w<-dcast(molten.data, Date+Station_ID~Pcode, mean)

Grab.w$NP<-Grab.w$TN/Grab.w$TP

head(Grab.w, 10)



molten.cont <- melt(Cont, id = c("Date","Station_ID","Pcode","Units"))

Cont.w<-dcast(molten.cont, Date+Station_ID~Pcode, mean)

head(Cont.w, 10)




```

#Data Summary

Subset of `r length(unique(BaseModel$Station_ID))` modeled segments in WASP

```{r, Basic Plots, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}

ggplot(data = BaseModel, aes(x = Date, y = FLOW_CMS, group = Station_ID, colour = Station_ID)) +
    geom_line() +
    facet_wrap(~ Station_ID)






ggplot(data = BaseModel, aes(x = Date, y = TPLoad, group = Station_ID, colour = Station_ID, )) +
  ylab("TP Load (lbs/day)") +
    geom_line() +
    facet_wrap(~ Station_ID)


#Boxplot - look at data distribution



tp<-ggplot(BaseModel, aes(x = Station_ID, y = TP, fill = Station_ID)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("TP (mg/L)")

tp


tn<-ggplot(BaseModel, aes(x = Station_ID, y = TN, fill = Station_ID)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("TN (mg/L)")

tn


np<-ggplot(BaseModel, aes(x = Station_ID, y = NP, fill = Station_ID)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("TN:TP Ratio")

np



```


```{r, Data Comparison, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}

LSPC188_tp<-ggplot(BaseModel,aes(x=Date,y=TP, fill="Base Model"))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="TP (mg/L)")+ylim(min(BaseModel$TP),max(BaseModel$TP))+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_blank(),axis.title.x=element_blank(), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Down","Frank_CottonLn","Franklin_Site_2","Franklin_Site_3")), aes(x=Date, y=TP, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=TP, color="Natural"))

LSPC188_tp

LSPC188_tn<-ggplot(BaseModel,aes(x=Date,y=TN))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="TN (mg/L)")+ylim(min(BaseModel$TN),max(BaseModel$TN))+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_blank(),axis.title.x=element_blank(), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Down","Frank_CottonLn","Franklin_Site_2","Franklin_Site_3")), aes(x=Date, y=TN, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=TN, color="Natural"))

LSPC188_tn

LSPC188_flow<-ggplot(BaseModel,aes(x=Date,y=FLOW_CMS))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="Flow (cms)")+ylim(min(BaseModel$FLOW_CMS),200)+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_blank(),axis.title.x=element_blank(), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Cont.w, Station_ID==c("USGS_03432400")), aes(x=Date, y=FLOW_CMS, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=FLOW_CMS, color="Natural"))

LSPC188_flow



LSPC188_np<-ggplot(BaseModel,aes(x=Date,y=NP))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="TN:TP ratio", x="Date")+ylim(min(BaseModel$NP),max(BaseModel$NP))+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_text(size=11),axis.title.x=element_text(size=11), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Down","Frank_CottonLn","Franklin_Site_2","Franklin_Site_3")), aes(x=Date, y=NP, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=NP, color="Natural"))

LSPC188_np

grid.arrange(LSPC188_tp,LSPC188_tn,LSPC188_flow,LSPC188_np, ncol=1,padding=100)


HARPETH_62<-ggplot(BaseModel,aes(x=Date,y=TP))+geom_line(data=subset(BaseModel,Station_ID=="HARPETH_62")) +theme_bw()+
  labs(y="TP (mg/L)")+ylim(min(BaseModel$TP),max(BaseModel$TP))+
  theme(
    axis.text.y=element_text(size=16),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_blank(),axis.title.x=element_blank(), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Up","Frank_Eff","Franklin_Site_1")), aes(x=Date, y=TP, color=Station_ID))


#HARPETH_62







#ppi=300
#png("awesome stacked time series.png",width=12*ppi, height=8*ppi, res=ppi)
#grid.arrange(LSPC188_tp,HARPETH_62, ncol=1)
#dev.off()


```


```{r, DO, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}

LSPC188_DO<-ggplot(BaseModel,aes(x=Date,y=DO, fill="Base Model"))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="DO (mg/L)")+ylim(min(BaseModel$DO),max(BaseModel$DO))+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_text(size=11),axis.title.x=element_text(size=11), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Down","Frank_CottonLn","Franklin_Site_2","Franklin_Site_3")), aes(x=Date, y=DO, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=DO, colour="Natural"))

LSPC188_DO

LSPC188_DO_PSinc<-ggplot(Base_PS,aes(x=Date,y=DO,fill="Base Model x 2.25 PS"))+geom_line(data=subset(Base_PS,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="DO (mg/L)")+ylim(min(Base_PS$DO),max(Base_PS$DO))+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_text(size=11),axis.title.x=element_text(size=11), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Grab.w, Station_ID==c("Frank_Down","Frank_CottonLn","Franklin_Site_2","Franklin_Site_3")), aes(x=Date, y=DO, colour=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=DO, color="Natural"))

LSPC188_DO_PSinc

LSPC188_flow<-ggplot(BaseModel,aes(x=Date,y=FLOW_CMS))+geom_line(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +theme_bw()+
  labs(y="Flow (cms)")+ylim(min(BaseModel$FLOW_CMS),200)+
  theme(
    axis.text.y=element_text(size=11),axis.title.y=element_text(size=12, vjust=1.2),
    axis.text.x=element_text(size=11),axis.title.x=element_text(size=11), 
    panel.border = element_rect(size=.8, colour = "black"))+
  geom_point(data=subset(Cont.w, Station_ID==c("USGS_03432400")), aes(x=Date, y=FLOW_CMS, color=Station_ID))+
  geom_line(data=subset(Natural, Station_ID=="LSPC188PERO"), aes(x=Date, y=FLOW_CMS, color="Natural"))

LSPC188_flow


grid.arrange(LSPC188_DO,LSPC188_DO_PSinc,LSPC188_flow, ncol=1,padding=100)



p<-ggplot(BaseModel, aes(x=Date, y=DO, fill=Station_ID)) + ggtitle("Base Model/Current Conditions") + theme_bw() +
  geom_line(aes(colour=Station_ID, group=Station_ID)) #+
  #geom_point(data=subset(Cont.w, Station_ID==c("USGS_03434500","HARPE062")) , aes(x=Date, y=DO))

p


p1<-ggplot(Natural, aes(x=Date, y=DO, fill=Station_ID)) + ggtitle("Natural Conditions") + theme_bw() +
  geom_line(aes(colour=Station_ID, group=Station_ID))

p1


p3<-ggplot(Base_PS, aes(x=Date, y=DO, fill=Station_ID)) + theme_bw() +
  geom_line(aes(colour=Station_ID, group=Station_ID))

p3





```




```{r, Seasonal Trends, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE, collapse=TRUE, tidy=TRUE}


monthOrder <- c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')
BaseModel$Month <- factor(format(BaseModel$Date, "%b"), levels = monthOrder)
BaseModel$Year <- factor(format(BaseModel$Date, "%Y"))
ggplot(BaseModel, aes(Month, TPLoad)) + geom_boxplot(data=subset(BaseModel,Station_ID=="LSPC188PERO")) +
  geom_boxplot(data=subset(BaseModel,Station_ID=="HARPETH_62")) + 
  stat_boxplot(geom ='errorbar') + ggtitle("TP Load (lbs/day)")

ggplot(BaseModel,aes(Month,TPLoad)) + geom_bar(stat="identity") + ggtitle("TP Load (lbs/month)")


Natural$Month <- factor(format(Natural$Date, "%b"), levels = monthOrder)
Natural$Year <- factor(format(Natural$Date, "%Y"))
ggplot(Natural, aes(Month, TPLoad)) + geom_boxplot(data=subset(Natural,Station_ID=="LSPC188PERO")) + stat_boxplot(geom ='errorbar') + ggtitle("Natural Model - TP Load (lbs/day)")


Base_NoFrank1$Month <- factor(format(Base_NoFrank1$Date, "%b"), levels = monthOrder)
Base_NoFrank1$Year <- factor(format(Base_NoFrank1$Date, "%Y"))
ggplot(Base_NoFrank1, aes(Month, TPLoad)) + geom_boxplot(data=subset(Base_NoFrank1,Station_ID=="LSPC188PERO")) + stat_boxplot(geom ='errorbar') + ggtitle("Base_NoFrank1 Model - TP Load (lbs/day)")


Base_PS1$Month <- factor(format(Base_PS1$Date, "%b"), levels = monthOrder)
Base_PS1$Year <- factor(format(Base_PS1$Date, "%Y"))
ggplot(Base_PS1, aes(Month, TPLoad)) + geom_boxplot(data=subset(Base_PS1,Station_ID=="LSPC188PERO")) + stat_boxplot(geom ='errorbar') + ggtitle("Base_PS1 Model - TP Load (lbs/day)")

##################

#LSPC188_tpload <- subset(BaseModel, Station_ID==c("LSPC188PERO","HARPETH_62"), select=c(Station_ID, Year, Month, TPLoad))
#meanTPLoad_62 <- subset(BaseModel, Station_ID=="HARPETH_62", select=c(Station_ID, Year, Month, TPLoad))
#meanTPLoad_188 <- subset(BaseModel, Station_ID=="LSPC188PERO", select=c(Station_ID, Year, Month, TPLoad))

#library(plyr)
#tpload62<-ddply(meanTPLoad_62, c("Month","Station_ID"), summarise, x = mean(TPLoad))

#meanTPLoad_62 <- join(meanTPLoad_62, tpload62, match="all")






#ggplot(LSPC188_tpload,aes(Year,TPLoad,colour=Station_ID)) +
#geom_point(data=LSPC188_tpload,size=I(2),alpha=I(0.6)) + 
#geom_line(data=meanTPLoad_62, aes(Month,x), size=I(1.5),alpha=I(0.6)) + 
##geom_line(data=mean(meanTPLoad_62$TPLoad),size=I(1.5),alpha=I(0.4)) + 
#theme_grey(base_size=15) +
#theme(legend.title = element_blank(), legend.position=c(.85,.85), axis.title.y=element_blank(),axis.text.x=element_blank()) + 
#ggtitle("TP Load (lbs/day)") + facet_grid(. ~ Month) + 
#xlab(paste("Years: 2011 to 2019"))













#theme_set(theme_classic())

#BaseModel$Date.ts<-as.ts(BaseModel$Date)

# Subset data
#Base_LSPC188 <- window(subset(BaseModel,Station_ID=="LSPC188PERO"), start=c(2012, 1), end=c(2019, 8))  # subset a smaller timewindow

# Plot
#ggseasonplot(subset(BaseModel,Station_ID=="LSPC188PERO"), x=BaseModel$Date.ts) + labs(title="Seasonal plot: International Airline Passengers")
#ggseasonplot(subset(BaseModel,Station_ID=="LSPC188PERO")) + labs(title="Seasonal plot: Air temperatures at Nottingham Castle")





```

```{r, TP, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE}

p <- ggplot(data=BaseModel1, aes(x=Date, y=DO, color=Station_ID)) +
  geom_line(data=subset(BaseModel1,Station_ID=="LSPC188PERO")) + 
  xlab("Year") +
  geom_line(data=subset(BaseModel1, Station_ID==sites))

p

p <- ggplot(data=Base_PS1, aes(x=Date, y=DO, color=Station_ID)) +
  geom_line(data=subset(Base_PS1,Station_ID=="LSPC188PERO")) + 
  xlab("Year") +
  geom_line(data=subset(Base_PS1, Station_ID==sites))

p

p <- ggplot(data=Natural1, aes(x=Date, y=DO, color=Station_ID)) +
  geom_line(data=subset(Natural1,Station_ID=="LSPC188PERO")) + 
  xlab("Year") +
  geom_line(data=subset(Natural1, Station_ID==sites))

p

```

```{r, DyGraphs}



LSPC188.base<-subset(BaseModel1,Station_ID=="LSPC188PERO")
dy.tpload <- xts(x = LSPC188.base$TPLoad, order.by = LSPC188.base$Date)

LSPC188.natural<-subset(Natural1,Station_ID=="LSPC188PERO")
dy.Nattpload <- xts(x = LSPC188.natural$TPLoad, order.by = LSPC188.natural$Date)

LSPC188.tpload<-cbind(dy.tpload,dy.Nattpload)


LSPC188.tpload <- na.locf(LSPC188.tpload)

p <- dygraph(LSPC188.tpload, main="TP Load at LSPC 188 - Below Frank", ylab="TP Load (lbs/day)") %>%
  dySeries("dy.tpload", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.Nattpload", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(3, "Set2")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p


LSPC192.base<-subset(BaseModel1,Station_ID=="LSPC192PERO")
dy.DO <- xts(x = LSPC192.base$DO, order.by = LSPC192.base$Date)

LSPC192.natural<-subset(Natural1,Station_ID=="LSPC192PERO")
dy.NatDO <- xts(x = LSPC192.natural$DO, order.by = LSPC192.natural$Date)

LSPC192.Base_PS<-subset(Base_PS1,Station_ID=="LSPC192PERO")
dy.Base_PSDO <- xts(x = LSPC192.Base_PS$DO, order.by = LSPC192.Base_PS$Date)

LSPC192.Cont<-subset(Cont.w,Station_ID==c("USGS_03433500","HARPE062"))
dy.ContDO <- xts(x = LSPC192.Cont$DO, order.by = LSPC192.Cont$Date)

LSPC192.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO,dy.ContDO)


#LSPC192.DO <- na.locf(LSPC192.DO)


p1 <- dygraph(LSPC192.DO, main="Dissolved Oxygen at LSPC 192 - Hwy 100", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(4, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p1


LSPC188.base<-subset(BaseModel1,Station_ID=="LSPC188PERO")
dy.DO <- xts(x = LSPC188.base$DO, order.by = LSPC188.base$Date)

LSPC188.natural<-subset(Natural1,Station_ID=="LSPC188PERO")
dy.NatDO <- xts(x = LSPC188.natural$DO, order.by = LSPC188.natural$Date)

LSPC188.Base_PS<-subset(Base_PS1,Station_ID=="LSPC188PERO")
dy.Base_PSDO <- xts(x = LSPC188.Base_PS$DO, order.by = LSPC188.Base_PS$Date)

LSPC188.Cont<-subset(Cont.w,Station_ID==c("USGS_03432400","USGS_03432350"))
dy.ContDO <- xts(x = LSPC188.Cont$DO, order.by = LSPC188.Cont$Date)

LSPC188.Grab<-subset(Grab.w,Station_ID==c("Frank_Down","Frank_CottonLn", "Frank_Eff", "Franklin_Site_2", "Franklin_Site_3"))
dy.GrabDO <- xts(x = LSPC188.Grab$DO, order.by = LSPC188.Grab$Date)


LSPC188.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO,dy.ContDO,dy.GrabDO)


#LSPC188.DO <- na.locf(LSPC188.DO)






p2 <- dygraph(LSPC188.DO, main="Dissolved Oxygen at LSPC 188 - Below Franklin STP", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p2



HARPETH_62.base<-subset(BaseModel1,Station_ID=="HARPETH_62")
dy.DO <- xts(x = HARPETH_62.base$DO, order.by = HARPETH_62.base$Date)

HARPETH_62.natural<-subset(Natural1,Station_ID=="HARPETH_62")
dy.NatDO <- xts(x = HARPETH_62.natural$DO, order.by = HARPETH_62.natural$Date)

HARPETH_62.Base_PS<-subset(Base_PS1,Station_ID=="HARPETH_62")
dy.Base_PSDO <- xts(x = HARPETH_62.Base_PS$DO, order.by = HARPETH_62.Base_PS$Date)

HARPETH_62.Cont<-subset(Cont.w,Station_ID==c("usgs_03432350","USGS_0343233905"))
dy.ContDO <- xts(x = HARPETH_62.Cont$DO, order.by = HARPETH_62.Cont$Date)

HARPETH_62.Grab<-subset(Grab.w,Station_ID==c("Frank_Up","Franklin_Site_1"))
dy.GrabDO <- xts(x = HARPETH_62.Grab$DO, order.by = HARPETH_62.Grab$Date)


HARPETH_62.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO,dy.ContDO,dy.GrabDO)


#HARPETH_62.DO <- na.locf(HARPETH_62.DO)






p3 <- dygraph(HARPETH_62.DO, main="Dissolved Oxygen at Harpeth 62 - Upstream of Franklin STP", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p3


JONES_167.base<-subset(BaseModel1,Station_ID=="JONES_167")
dy.DO <- xts(x = JONES_167.base$DO, order.by = JONES_167.base$Date)

JONES_167.natural<-subset(Natural1,Station_ID=="JONES_167")
dy.NatDO <- xts(x = JONES_167.natural$DO, order.by = JONES_167.natural$Date)

JONES_167.Base_PS<-subset(Base_PS1,Station_ID=="JONES_167")
dy.Base_PSDO <- xts(x = JONES_167.Base_PS$DO, order.by = JONES_167.Base_PS$Date)

#JONES_167.Cont<-subset(Cont.w,Station_ID==c("usgs_03432350","USGS_0343233905"))
#dy.ContDO <- xts(x = JONES_167.Cont$DO, order.by = JONES_167.Cont$Date)

#JONES_167.Grab<-subset(Grab.w,Station_ID==c("Frank_Up","Franklin_Site_1"))
#dy.GrabDO <- xts(x = JONES_167.Grab$DO, order.by = JONES_167.Grab$Date)


JONES_167.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO)


#JONES_167.DO <- na.locf(JONES_167.DO)






p4 <- dygraph(JONES_167.DO, main="Dissolved Oxygen at JONES_167 - Mouth of Jones Creek", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p4



LSPC183PERO.base<-subset(BaseModel1,Station_ID=="LSPC183PERO")
dy.DO <- xts(x = LSPC183PERO.base$DO, order.by = LSPC183PERO.base$Date)

LSPC183PERO.natural<-subset(Natural1,Station_ID=="LSPC183PERO")
dy.NatDO <- xts(x = LSPC183PERO.natural$DO, order.by = LSPC183PERO.natural$Date)

LSPC183PERO.Base_PS<-subset(Base_PS1,Station_ID=="LSPC183PERO")
dy.Base_PSDO <- xts(x = LSPC183PERO.Base_PS$DO, order.by = LSPC183PERO.Base_PS$Date)

#LSPC183PERO.Cont<-subset(Cont.w,Station_ID==c("usgs_03432350","USGS_0343233905"))
#dy.ContDO <- xts(x = LSPC183PERO.Cont$DO, order.by = LSPC183PERO.Cont$Date)

#LSPC183PERO.Grab<-subset(Grab.w,Station_ID==c("Frank_Up","Franklin_Site_1"))
#dy.GrabDO <- xts(x = LSPC183PERO.Grab$DO, order.by = LSPC183PERO.Grab$Date)


LSPC183PERO.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO)


#LSPC183PERO.DO <- na.locf(LSPC183PERO.DO)






p4 <- dygraph(LSPC183PERO.DO, main="Dissolved Oxygen at LSPC183PERO - Headwaters", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p4


S_HARPETH_124.base<-subset(BaseModel1,Station_ID=="S_HARPETH_124")
dy.DO <- xts(x = S_HARPETH_124.base$DO, order.by = S_HARPETH_124.base$Date)

S_HARPETH_124.natural<-subset(Natural1,Station_ID=="S_HARPETH_124")
dy.NatDO <- xts(x = S_HARPETH_124.natural$DO, order.by = S_HARPETH_124.natural$Date)

S_HARPETH_124.Base_PS<-subset(Base_PS1,Station_ID=="S_HARPETH_124")
dy.Base_PSDO <- xts(x = S_HARPETH_124.Base_PS$DO, order.by = S_HARPETH_124.Base_PS$Date)

#S_HARPETH_124.Cont<-subset(Cont.w,Station_ID==c("usgs_03432350","USGS_0343233905"))
#dy.ContDO <- xts(x = S_HARPETH_124.Cont$DO, order.by = S_HARPETH_124.Cont$Date)

#S_HARPETH_124.Grab<-subset(Grab.w,Station_ID==c("Frank_Up","Franklin_Site_1"))
#dy.GrabDO <- xts(x = S_HARPETH_124.Grab$DO, order.by = S_HARPETH_124.Grab$Date)


S_HARPETH_124.DO<-cbind(dy.DO,dy.NatDO,dy.Base_PSDO)


#S_HARPETH_124.DO <- na.locf(S_HARPETH_124.DO)






p5 <- dygraph(S_HARPETH_124.DO, main="Dissolved Oxygen at S_HARPETH_124 - Mouth of South Harpeth", ylab="DO (mg/L)") %>%
  dySeries("dy.DO", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatDO", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p5


```

```{r, Probability Graphs, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE}

DF <- melt(BaseModel, id=c("Date","Station_ID"))


ggplot(BaseModel, aes(x = TP, col = Station_ID))+
   stat_ecdf(lwd = 1.2)+
  geom_hline(yintercept=c(.95,0.75), color="black")+
  xlim(0,1.2)+
  geom_vline(xintercept = c(0.62,0.34))+labs(title="Base Model - EPA",
        x ="TP (mg/L)", y = "Probability of Occurence")
  
  
ggplot(Natural, aes(x=TP, col=Station_ID))+
  stat_ecdf(lwd=1.2)+
  geom_hline(yintercept=c(.95,0.75), color="black")+
  xlim(0,1.2)+labs(title="Model - Natural",
        x ="TP (mg/L)", y = "Probability of Occurence")

ggplot(Base_PS, aes(x=TP, col=Station_ID))+
  stat_ecdf(lwd=1.2)+
  geom_hline(yintercept=c(.95,0.75), color="black")+
  xlim(0,1.2)+labs(title="Base_PS",
        x ="TP (mg/L)", y = "Probability of Occurence")


```

TP concentrations and NP ratios visualized with cumulative distribution frequency


```{r, NP Ratios}

ggplot(BaseModel, aes(x = NP, col = Station_ID))+
   stat_ecdf(lwd = 1.2)+
  geom_hline(yintercept=c(.95,0.75), color="black")+
  xlim(0,10)+
  geom_vline(xintercept = c(5,3.1))+labs(title="Base Model - EPA",
        x ="NP Ratios", y = "Probability of Occurence")
  
  
ggplot(Natural, aes(x=NP, col=Station_ID))+
  stat_ecdf(lwd=1.2)+
  geom_hline(yintercept=c(.95,0.75), color="black")+
  xlim(0,10)+labs(title="Model - Natural",
        x ="NP Ratios", y = "Probability of Occurence")


```


```{r, No Franklin Graphs, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE}


LSPC188PERO.NoFrank<-subset(Base_NoFrank1,Station_ID=="LSPC188PERO")
dy.NoFrankTPLoad <- xts(x = LSPC188PERO.NoFrank$TPLoad, order.by = LSPC188PERO.NoFrank$Date)

LSPC188PERO.base<-subset(BaseModel1,Station_ID=="LSPC188PERO")
dy.TPLoad <- xts(x = LSPC188PERO.base$TPLoad, order.by = LSPC188PERO.base$Date)

LSPC188PERO.natural<-subset(Natural1,Station_ID=="LSPC188PERO")
dy.NatTPLoad <- xts(x = LSPC188PERO.natural$TPLoad, order.by = LSPC188PERO.natural$Date)

LSPC188PERO.Base_PS<-subset(Base_PS1,Station_ID=="LSPC188PERO")
dy.Base_PSTPLoad <- xts(x = LSPC188PERO.Base_PS$TPLoad, order.by = LSPC188PERO.Base_PS$Date)



LSPC188PERO.FrankPermit<-subset(Base_NoFrank1,Station_ID=="LSPC188PERO")
dy.FrankPermitTPLoad <- xts(x = LSPC188PERO.FrankPermit$TPLoad+174.5, order.by = LSPC188PERO.FrankPermit$Date)


#LSPC188PERO.Cont<-subset(Cont.w,Station_ID==c("usgs_03432350","USGS_0343233905"))
#dy.ContTPLoad <- xts(x = LSPC188PERO.Cont$TPLoad, order.by = LSPC188PERO.Cont$Date)

#LSPC188PERO.Grab<-subset(Grab.w,Station_ID==c("Frank_Up","Franklin_Site_1"))
#dy.GrabTPLoad <- xts(x = LSPC188PERO.Grab$TPLoad, order.by = LSPC188PERO.Grab$Date)


LSPC188PERO.TPLoad<-cbind(dy.TPLoad,dy.NatTPLoad,dy.Base_PSTPLoad,dy.NoFrankTPLoad,dy.FrankPermitTPLoad)


LSPC188PERO.TPLoad <- na.locf(LSPC188PERO.TPLoad)






p5 <- dygraph(LSPC188PERO.TPLoad, main="TP Load at LSPC188PERO - Below Franklin", ylab="TPLoad (lbs/day)") %>%
  dySeries("dy.TPLoad", drawPoints = TRUE, strokePattern="dashed", color="red") %>%
  dySeries("dy.NatTPLoad", drawPoints= T, color="blue") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors = RColorBrewer::brewer.pal(5, "Set1")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)


p5








```

FrankPermitTPLoad = Permit limit 174 lbs/day added to No Franklin Model in order to represent TP Load in Harpeth with addition of Franklin Permit Limits


```{r, NPDES Graphs, warning=FALSE, include=TRUE, echo=TRUE, error=FALSE, message=FALSE}



a<-subset(NPDES, Station_ID=="TN0020460")
b<-subset(NPDES, Station_ID=="TN0027278")
c<-subset(NPDES, Station_ID=="TN0028827")
d<-subset(NPDES, Station_ID=="TN0029718")
e<-subset(NPDES, Station_ID=="TN0057789")

f<-subset(NPDES, Station_ID=="TN0057827")
g<-subset(NPDES, Station_ID=="TN0057835")
h<-subset(NPDES, Station_ID=="TN0059790")
i<-subset(NPDES, Station_ID=="TN0060216")
j<-subset(NPDES, Station_ID=="TN0062332")

k<-subset(NPDES, Station_ID=="TN0064297")
l<-subset(NPDES, Station_ID=="TN0066958")
m<-subset(NPDES, Station_ID=="TN0067164")
n<-subset(NPDES, Station_ID=="TN0067873")
o<-subset(BaseModel, Station_ID=="HARPETH_1")


#c$TPLoad.csum<-c$TPLoad*0.00220462*NPDES$FLOW*86400

#MonthlyLoad <- function(x,y){
#  return(x*y*0.00220462*86400*30)
#}

#add_one_if <- function(vector, x_id, y_id, run_on_id){
#    if(vector[run_on_id]){
#        return(add_one(vector,x_id))}
#    else{
#        return(vector[x_id])
#    }
#}

#test$y <- apply(test, 1, add_one_if, x_id = 1, y_id = 2, run_on_id = 3)


#NPDES.list<-c("a","b","c","d","e","f","g","h","i","j","k","l","m","n")


#for (i in NPDES.list) {

#i$Date2=dplyr::lead(i$Date)

#i$Date.dif<-difftime(i$Date2,i$Date)


#}




#NPDES$TPLoad.csum <- ave(NPDES$TPLoad, NPDES$Station_ID, FUN=cumsum)

#NPDES$NP<-NPDES$TN/NPDES$TP

#NPDES1<-NPDES




#PS.TPload<-max(a$TPLoad.csum)+max(b$TPLoad.csum)+max(c$TPLoad.csum)+max(d$TPLoad.csum)+max(e$TPLoad.csum)+max(f$TPLoad.csum)+max(g$TPLoad.csum)+max(h$TPLoad.csum)+max(i$TPLoad.csum)+max(j$TPLoad.csum)+max(k$TPLoad.csum)+max(l$TPLoad.csum)+max(m$TPLoad.csum)+max(n$TPLoad.csum)

#PS.TPload #Cumulative TP Load between Jan 2011 and Dec 2019 of all combined Point Sources from NPDES permits
#max(o$TPLoad.csum) #Cumulative TP Load between Jan 2011 and Dec 2019 from HARPETH mouth (HARPETH_1)


#PS.TPload/max(o$TPLoad.csum)



#PS.TPload<-data.frame(c$Date,PS.TPload)

#colnames(PS.TPload)[1] <- "Date"
#colnames(PS.TPload)[2] <- "TPLoad.csum"

#p <- ggplot(data=PS.TPload, aes(x=Date, y=log(TPLoad.csum))) +
#  geom_line() + 
#  xlab("Year") +
#  geom_line(data=subset(BaseModel, Station_ID=="HARPETH_1"))

#p


```


